{% extends "base.html" %}
{% block title %}Your TOTP Codes{% endblock %}

{% block content %}
  <script defer src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script defer src="{{ url_for('static', path='js/totp-list.js') }}"></script>
  <script>
    (function () {
      const desktop = document.getElementById('select-all');
      const mobile  = document.getElementById('select-all-mobile');
      const cancel  = document.getElementById('export-cancel');
      const rowChecks = () => Array.from(document.querySelectorAll('.row-check'));

      function setSelectAll(checked) {
        [desktop, mobile].forEach(el => {
          if (!el) return;
          el.indeterminate = false;
          el.checked = checked;
          el.dispatchEvent(new Event('change', { bubbles: true }));
        });
      }

      function applyToRows(checked) {
        rowChecks().forEach(cb => {
          cb.checked = checked;
          cb.dispatchEvent(new Event('change', { bubbles: true }));
        });
      }

      function syncSelectAllFromRows() {
        const rows = rowChecks();
        const total = rows.length;
        const selected = rows.filter(cb => cb.checked).length;
        const all = total > 0 && selected === total;
        const none = selected === 0;
        [desktop, mobile].forEach(el => {
          if (!el) return;
          el.indeterminate = !none && !all;
          el.checked = all;
        });
      }

      if (desktop && mobile) {
        mobile.addEventListener('change', () => {
          desktop.checked = mobile.checked;
          desktop.indeterminate = false;
          applyToRows(mobile.checked);
        });

        desktop.addEventListener('change', () => {
          mobile.checked = desktop.checked;
          mobile.indeterminate = false;
          applyToRows(desktop.checked);
        });
      }

      rowChecks().forEach(cb => cb.addEventListener('change', syncSelectAllFromRows));

      if (cancel) {
        cancel.addEventListener('click', () => {
          applyToRows(false);
          setSelectAll(false);
        });
      }

      syncSelectAllFromRows();
    })();
  </script>

  <link rel="stylesheet" href="{{ url_for('static', path='css/ring.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', path='css/checkbox.css') }}">

  <div class="flex justify-between items-center max-w-5xl mx-auto mb-4 px-4 sm:px-6">
    <h1 class="text-2xl font-bold text-primary">ðŸ”‘ Your Codes</h1>
    <button id="import-btn" class="bg-primary hover:bg-primary-hover text-white px-4 py-2 rounded-md">Import</button>
  </div>

  <div class="bg-white shadow-xl rounded-xl p-4 sm:p-6 max-w-5xl mx-auto">
    <div class="flex flex-wrap gap-2 mb-4 px-2">
      <button id="my-codes-tab" class="px-4 py-2 text-sm font-medium text-primary border-b-2 border-primary">My Codes</button>
      <button id="shared-with-me-tab" class="px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-primary hover:border-primary">Shared with me</button>
    </div>

    <div class="md:hidden mb-3 px-2 flex items-center justify-between">
      <label class="flex items-center gap-3 text-sm text-gray-700">
        <div class="checkbox-wrapper-45">
          <input id="select-all-mobile" type="checkbox" />
          <label class="cbx-45" for="select-all-mobile">
            <div class="cbx-45-flip">
              <div class="cbx-45-front"></div>
              <div class="cbx-45-back"><svg viewBox="0 0 16 14"><path d="M2 8.5L6 12.5L14 1.5"/></svg></div>
            </div>
          </label>
        </div>
        <span>Select all</span>
      </label>
    </div>

    <div id="my-codes" class="tab-content">
      <div class="overflow-x-auto">
        <table class="min-w-full border-separate border-spacing-y-2" id="totp-table" role="table" aria-label="My TOTP codes">
          <thead class="hidden md:table-header-group">
            <tr class="text-sm text-gray-600 bg-info-200">
              <th class="w-12 px-4 py-2 text-center">
                <div class="mx-auto w-fit">
                  <div class="checkbox-wrapper-45">
                    <input id="select-all" type="checkbox" />
                    <label class="cbx-45" for="select-all">
                      <div class="cbx-45-flip">
                        <div class="cbx-45-front"></div>
                        <div class="cbx-45-back"><svg viewBox="0 0 16 14"><path d="M2 8.5L6 12.5L14 1.5"/></svg></div>
                      </div>
                    </label>
                  </div>
                </div>
              </th>
              <th class="text-left px-4 py-2">Account / Issuer</th>
              <th class="text-center px-4 py-2">Current Code</th>
              <th class="text-center px-4 py-2">Time Left</th>
              <th class="text-center px-4 py-2">Actions</th>
            </tr>
          </thead>

          <tbody class="block md:table-row-group space-y-3 md:space-y-0">
            {% for t in totps %}
            <tr class="block md:table-row bg-gray-100 md:bg-transparent rounded-xl md:rounded-none shadow md:shadow-none p-3 md:p-0 transition" data-id="{{ t.id }}">
              <td class="w-12 block md:table-cell text-left md:text-center align-middle px-4 py-2">
                <div class="flex items-center md:justify-center gap-3">
                  <div class="checkbox-wrapper-45">
                    <input id="cbx-{{ t.id }}" type="checkbox" class="row-check" value="{{ t.id }}" />
                    <label class="cbx-45" for="cbx-{{ t.id }}">
                      <div class="cbx-45-flip">
                        <div class="cbx-45-front"></div>
                        <div class="cbx-45-back"><svg viewBox="0 0 16 14"><path d="M2 8.5L6 12.5L14 1.5"/></svg></div>
                      </div>
                    </label>
                  </div>
                  <span class="text-xs font-semibold text-gray-500 md:hidden">Select</span>
                </div>
              </td>

              <td class="block md:table-cell px-2 md:px-4 py-2 rounded-l-lg text-gray-800">
                <div class="flex md:block items-start justify-between gap-3">
                  <span class="text-xs font-semibold text-gray-500 md:hidden">Account / Issuer</span>
                  <div class="min-w-0">
                    <div class="font-medium break-words">{{ t.account }}</div>
                    <div class="text-sm text-gray-500 break-words">{{ t.issuer }}</div>
                  </div>
                </div>
              </td>

              <td class="block md:table-cell px-2 md:px-4 py-2 text-left md:text-center align-middle">
                <div class="flex md:block items-center justify-between gap-3">
                  <span class="text-xs font-semibold text-gray-500 md:hidden">Current Code</span>
                  <div class="relative inline-block">
                    <code onclick="copyCode(this)" class="cursor-pointer bg-info-200 text-primary px-3 py-1 rounded-full font-mono text-sm transition">{{ t.code }}</code>
                  </div>
                </div>
              </td>

              <td class="block md:table-cell px-2 md:px-4 py-2 text-left md:text-center align-middle">
                <div class="flex md:block items-center justify-between gap-3">
                  <span class="text-xs font-semibold text-gray-500 md:hidden">Time Left</span>
                  <div class="flex justify-start md:justify-center items-center">
                    <svg width="32" height="32" viewBox="0 0 36 36" class="countdown-ring text-info">
                      <circle class="countdown-ring__bg" stroke="#e5e7eb" stroke-width="3" fill="transparent" r="13" cx="18" cy="18"/>
                      <circle class="countdown-ring__progress" stroke="#3B82F6" stroke-width="3" fill="transparent" r="13" cx="18" cy="18" stroke-linecap="round" stroke-dasharray="81.6814" stroke-dashoffset="0"/>
                    </svg>
                  </div>
                </div>
              </td>

              <td class="block md:table-cell px-2 md:px-4 py-2 text-left md:text-center rounded-r-lg">
                <div class="flex flex-wrap md:justify-center items-center gap-2">
                  {% if t.is_shared %}
                  <button onclick="showSharedUsers({{ t.id }})" class="bg-info-500 hover:bg-info-600 text-white px-3 py-1.5 rounded-md text-sm shadow-sm transition">Shared</button>
                  {% endif %}
                  <form method="post" action="/totp/delete" onsubmit="return confirm('Are you sure?');" class="inline">
                    <input type="hidden" name="ids" value="{{ t.id }}">
                    <button type="submit" class="bg-danger-500 hover:bg-danger-600 text-white px-3 py-1.5 rounded-md text-sm shadow-sm transition">Delete</button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div id="shared-with-me" class="tab-content hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full border-separate border-spacing-y-2" id="shared-totp-table" role="table" aria-label="Shared TOTP codes">
          <thead class="hidden md:table-header-group">
            <tr class="text-sm text-gray-600 bg-info-200">
              <th class="text-left px-4 py-2">Account / Issuer</th>
              <th class="text-center px-4 py-2">Owner</th>
              <th class="text-center px-4 py-2">Current Code</th>
              <th class="text-center px-4 py-2">Time Left</th>
            </tr>
          </thead>
          <tbody class="block md:table-row-group space-y-3 md:space-y-0">
            {% for t in shared_totps %}
            <tr class="block md:table-row bg-gray-100 md:bg-transparent rounded-xl md:rounded-none shadow md:shadow-none p-3 md:p-0 transition" data-id="{{ t.id }}">
              <td class="block md:table-cell px-2 md:px-4 py-2 rounded-l-lg text-gray-800">
                <div class="flex md:block items-start justify-between gap-3">
                  <span class="text-xs font-semibold text-gray-500 md:hidden">Account / Issuer</span>
                  <div class="min-w-0">
                    <div class="font-medium break-words">{{ t.account }}</div>
                    <div class="text-sm text-gray-500 break-words">{{ t.issuer }}</div>
                  </div>
                </div>
              </td>
              <td class="block md:table-cell px-2 md:px-4 py-2 text-left md:text-center align-middle">
                <div class="flex md:block items-center justify-between gap-3">
                  <span class="text-xs font-semibold text-gray-500 md:hidden">Owner</span>
                  <div class="text-sm font-semibold text-gray-700 break-words">{{ t.owner_email }}</div>
                </div>
              </td>
              <td class="block md:table-cell px-2 md:px-4 py-2 text-left md:text-center align-middle">
                <div class="flex md:block items-center justify-between gap-3">
                  <span class="text-xs font-semibold text-gray-500 md:hidden">Current Code</span>
                  <div class="relative inline-block">
                    <code onclick="copyCode(this)" class="cursor-pointer bg-info-200 text-primary px-3 py-1 rounded-full font-mono text-sm transition">{{ t.code }}</code>
                  </div>
                </div>
              </td>
              <td class="block md:table-cell px-2 md:px-4 py-2 text-left md:text-center align-middle rounded-r-lg">
                <div class="flex md:block items-center justify-between gap-3">
                  <span class="text-xs font-semibold text-gray-500 md:hidden">Time Left</span>
                  <div class="flex justify-start md:justify-center items-center">
                    <svg width="32" height="32" viewBox="0 0 36 36" class="countdown-ring text-info">
                      <circle class="countdown-ring__bg" stroke="#e5e7eb" stroke-width="3" fill="transparent" r="13" cx="18" cy="18"/>
                      <circle class="countdown-ring__progress" stroke="#3B82F6" stroke-width="3" fill="transparent" r="13" cx="18" cy="18" stroke-linecap="round" stroke-dasharray="81.6814" stroke-dashoffset="0"/>
                    </svg>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="export-bar" class="fixed inset-x-0 bottom-0 z-40 flex justify-center pb-6 pointer-events-none translate-y-full opacity-0 transition-all duration-300">
    <div class="pointer-events-auto bg-white shadow-2xl border border-gray-200 rounded-xl px-4 sm:px-6 py-3 sm:py-4 flex items-center gap-2 sm:gap-4 flex-wrap">
      <form id="export-selected-form" method="post" action="/totp/export" class="flex items-center gap-2 sm:gap-4">
        <input type="hidden" name="ids" id="export-ids">
        <button type="button" id="export-btn" class="bg-primary hover:bg-primary-hover text-primary-text px-4 sm:px-5 py-2 rounded-md text-sm shadow-md opacity-50 cursor-not-allowed" disabled>Export selected</button>
      </form>
      <form id="share-selected-form" method="post" action="/totp/share" class="flex items-center gap-2 sm:gap-4">
        <input type="hidden" name="totp_ids" id="share-ids">
        <button type="button" id="share-btn" class="bg-info-500 hover:bg-info-600 text-white px-4 sm:px-5 py-2 rounded-md text-sm shadow-md opacity-50 cursor-not-allowed" disabled>Share selected</button>
      </form>
      <form id="delete-selected-form" method="post" action="/totp/delete" class="flex items-center gap-2 sm:gap-4">
        <input type="hidden" name="ids" id="delete-ids">
        <button type="submit" id="delete-selected-btn" onclick="return confirm('Are you sure you want to delete selected item(s)?');" class="bg-danger-500 hover:bg-danger-600 text-white px-4 sm:px-5 py-2 rounded-md text-sm shadow-md opacity-50 cursor-not-allowed" disabled>Delete selected</button>
      </form>
      <button type="button" id="export-cancel" class="text-gray-500 hover:text-gray-700 text-sm">Cancel</button>
    </div>
  </div>

  <div id="share-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6 w-[90vw] max-w-96">
      <h2 class="text-xl font-semibold mb-4">Share TOTP Codes</h2>
      <form id="share-form" method="post" action="/totp/share">
        <input type="hidden" name="totp_ids" id="share-totp-ids">
        <div class="mb-4">
          <label for="share-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input type="email" id="share-email" name="email" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary"/>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="share-cancel" class="px-4 py-2">Cancel</button>
          <button type="submit" class="bg-primary hover:bg-primary-hover text-white px-4 py-2 rounded">Share</button>
        </div>
      </form>
    </div>
  </div>

  <div id="shared-users-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6 w-[90vw] max-w-96">
      <h2 class="text-xl font-semibold mb-4">Shared With</h2>
      <div id="shared-users-list" class="mb-4"></div>
      <div class="flex justify-end">
        <button type="button" id="shared-users-cancel" class="px-4 py-2">Close</button>
      </div>
    </div>
  </div>

  <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6 w-[90vw] max-w-96">
      <h2 class="text-xl font-semibold mb-4">Import TOTP URI(s)</h2>
      <form id="import-form" method="post" action="/totp/import">
        <div class="mb-4">
          <input type="file" id="import-file" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition"/>
          <p class="text-xs mt-1 text-gray-500">Choose an image of your migration QR code to auto-fill the URI.</p>
        </div>
        <div class="mb-4">
          <textarea id="import-text" name="uri" rows="3" placeholder="Or paste migration QR image (Ctrl+V)" class="w-full border rounded p-2 text-sm"></textarea>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="import-cancel" class="px-4 py-2">Cancel</button>
          <button type="submit" class="bg-primary hover:bg-primary-hover text-white px-4 py-2 rounded">Import</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}
